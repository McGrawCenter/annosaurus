<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>Annosaurus</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script type='text/javascript' src='js/jquery.min.js'></script>
  <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/5.0.1/openseadragon.min.js"></script>
  <script src="js/annotorious/openseadragon-annotorious.min.js"></script>
  <script src="https://tripleyefish.com/tools/js/parser.js"></script>  
  <script src="js/file.js"></script>
  <script src="js/cropper.js"></script>
  <link rel="stylesheet" href="css/style.css">
 


</head>
<body>
<header>
      <form id="input" name="input" style="display:flex;width:60%;">
        <input type="text" name="url" id="url" placeholder="Manifest URL" value=""/>
        <!--<input type="submit" id="go" value="Go"/>-->
        <input type="image" src="images/dinosaur.svg" alt="Submit Form" style="height: 30px;padding: 10px;border: solid 1px gray;"/>
      </form>
      <div id="gallery-right-toolbar">
        <a href="#" id="import" class="button">Import</a>
        <a href="#" id="export" class="button">Export</a>
      </div>       
</header>
<div class='container'>
  <div id="left-panel">
  
 
      <div id="gallery-left">
        <div id="gallery-left-slider"></div>
      </div>  
  
  
  </div>
  <div id="center-panel">
  
  
     <div id="openseadragon"></div> 
     <div id="filmstrip"><div id="filmstrip-left-slider" class="gallery"></div></div>
 
  
  </div>
  <div id="right-panel">
      <form name='myform' id="annoForm" class='' style='display:none;'>
           <div id="preview"></div>
           <input type='hidden' id='ID' value=""/>
           <input type='hidden' id='image' value=""/>
           <input type='hidden' id='region' value=""/>
           <input type='hidden' id='rotation' value=""/>
           <textarea id="textbody"></textarea>
           <input type='text' id='tagbody' value=""/>
           <div style='text-align:right'><a href="#" class='button close'>Cancel</a><a href='#' class='button create'>Create</a></div>
      </form>  
  
      <div id="gallery-right">
        <div id="gallery-right-slider"></div>
      </div>  
  
  
  </div>
</div>



<script type="text/javascript">
var anno;
var current = {};

var manifests = {};
var cards = {};
var crops = {};
var annotations = {};
var tilesources = [];
var mode = 'create';






var options = {
    id: "openseadragon",
    prefixUrl: "js/openseadragon/images/",
    showRotationControl: true,
    tileSources: tilesources
}

var viewer = OpenSeadragon(options);
var c = new Cropper(viewer, doCrop);

viewer.addHandler("open", openHandler);
//viewer.addHandler('rotate', rotateHandler);

function rotateHandler() {
	var r = viewer.viewport.getRotation();
        if (r < 0) {
            r = 360 + r;
        }
        if (r == 360) {
            r = 0;
        }
        jQuery("#rotation").val(r);
}

function openHandler() {
    if (current.target.source.selector) {
        var coords = current.target.source.selector.value.replace('xywh=', '');
        var imageCoords = coords.split(",");
        var tl = viewer.viewport.imageToViewportCoordinates(imageCoords[0], imageCoords[1]);
        var br = viewer.viewport.imageToViewportCoordinates(imageCoords[2], imageCoords[3]);
        var box1 = new OpenSeadragon.Rect(tl.x, tl.y, br.x, br.y);
        viewer.viewport.fitBounds(box1);
    }

}




    /*************************
     * get the url vars
     ***********************************/
    function getURLValues() {
        var search = window.location.search.replace(/^\?/, '').replace(/\+/g, ' ');
        var values = {};
        if (search.length) {
            var part, parts = search.split('&');

            for (var i = 0, iLen = parts.length; i < iLen; i++) {
                part = parts[i].split('=');
                values[part[0]] = window.decodeURIComponent(part[1]);
            }
        }
        return values;
    }


/**************************
* if there is a manifest url var, load it
*************************************************/
var vars = this.getURLValues();
  if (typeof vars.manifest !== 'undefined') {
  var url = vars.manifest;
  jQuery("#url").val(url);
  loadManifest(url);
}
/**************************
* make the right gallery draggable/sortable
*************************************************/
$( "#gallery-right-slider" ).sortable({
    update: function(e) {
    
	var newcrops = [];
        jQuery('.right').each(function(i,v){
          newcrops[v.id] = crops[v.id];
        });
        crops = newcrops;
    }
});












function doCrop(e) {
/*
    jQuery("#preview").html(`<img src='${current.body[1].service[0].id}/${e.region}/350,/${e.rotation}/default.jpg'/>`);
    jQuery("#region").val(e.region);
    jQuery("#rotation").val(e.rotation);  
*/
    switch(mode) {
      case 'create':
        var image =  `${current.body[1].service[0].id}/${e.region}/300,/${e.rotation}/default.jpg`;
        populateForm( null, image, e.region, e.rotation, '', '');      
      break;
      
      case 'update':
        var image =  `${current.body[1].service[0].id}/${e.region}/300,/${e.rotation}/default.jpg`;
        updatePreview( image);       
      break;
    }

}

function populateForm(id, image, region, rotation, text, tags) {
    jQuery("#ID").val(id);
    jQuery("#image").val(image);
    jQuery("#preview").html(`<img src='${image}'/>`);
    jQuery("#region").val(region);
    jQuery("#rotation").val(rotation);
    jQuery("#textbody").val(text);
    jQuery("#tagbody").val(tags);
    showForm();
}

function updatePreview(image) {
    jQuery("#image").val(image);
    jQuery("#preview").html(`<img src='${image}'/>`);
    showForm();
}

function hideForm() {
    jQuery("#annoForm").hide();
}
function showForm() {
    jQuery("#annoForm").show();
}
function resetForm() {
    jQuery("#ID").val("");
    jQuery("#image").val("");
    jQuery("#preview").html("");
    jQuery("#region").val("");
    jQuery("#rotation").val(0);
    jQuery("#textbody").val("");
    jQuery("#tagbody").val("");
    showForm();
    mode = 'create';
    setMode();    
}




function drawCrops() {

    jQuery("#gallery-right-slider").empty();
    for (i in crops) {
        var id = crops[i].id;
        var image = crops[i].body[1].id;
        var label = crops[i].body[0].value;
        var classname = 'right';
        var container  = 'gallery-right-slider';
        addCard(id, container, image, label, classname);
        //jQuery("#gallery-right-slider").append(makeCard(crops[i]), 'right'));
    }

}


jQuery(".crop").click(function(e) {
    toggleCrop();
    e.preventDefault();
});


    jQuery('.close').click(function(e) {
        hideForm();
    });


    jQuery(document).on("click", ".card.left", function(e) {
        setActiveLeft(jQuery(this));
        mode = 'create';
        setMode();
        console.log(mode);
        var id = jQuery(this).attr('id');
        jQuery('#region').val('full');
        jQuery('#rotation').val('0');
        viewer.viewport.setRotation(0);
        jQuery('#textbody').val('');
        jQuery('#tagbody').val('');
        var o = cards[id];
        current = o;
        viewer.open(o.body[1].service[0].id + "/info.json");
        var image = o.body[1].service[0].id + "/full/300,/0/default.jpg";
        populateForm( '', image, 'full', 0, '', '');
        showForm();
    });



    jQuery(document).on("click", ".card.right", function(e) {
        setActiveRight(jQuery(this));
        mode = 'update';
        setMode();
        console.log(mode);    
        var id = jQuery(this).attr('id');
        var o = crops[id];
        current = o;
        var image = o.body[1].id;
        var parts = image.split("/");
        var text = o.body[0].value;
        var tags = "";
	populateForm( id, image, parts[7], parts[9], text, tags);	
        populateViewer(current);

    });



/************************************
 * 
 *************************************/
function makeid() {
    let result = '';
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const charactersLength = characters.length;
    let counter = 0;
    while (counter < 12) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
        counter += 1;
    }
    return result;
}


function loadManifest(url) {

    var parser = new Parser();
    parser.parse(url).then((data) => {

        manifests[url] = data

        switch (data.type) {

            case "Collection":
                data.items.forEach((item) => {
                    loadManifest(item);
                });
                break;

            default:

                var html = `<h5 class='manifest-label'>${data.label}</h5><div>`;

                for (i in data.items) {
                    var id = makeid();
                    var z = new Annotation(id);
                    z.setLabel(data.items[i].label);
                    z.setCanvas(data.items[i].canvas);
                    z.setManifest(data.items[i].manifest);

                    z.setImageBody(data.items[i].serviceurl, 'full', '0');
                    //z.setThumbnail(data.items[i].serviceurl+"/full/300,/0/default.jpg");
                    cards[id] = z;
                    tilesources[id] = data.items[i].serviceurl;
                    html += z.makeCard('left');
                }
                html += "</div>";
                jQuery("#gallery-left-slider").prepend(html);

                break;

        }
    }).then((data) => {
        console.log('loaded');
    });


}


//id, container, image, label, id, classname
function addManifest(id, container, image, label, classname = "") {

    var c = `<div class="card small ${classname}" id='${id}'>
      <div class="section media"><img src="${image}"/>
      </div>
      <div class="section meta">${label}</div>
      </div>`;
    jQuery("#" + container).append(c);

}

function setActiveLeft(o) {
  jQuery(".card.left").removeClass('active');
  o.addClass('active');
}
function setActiveRight(o) {
  jQuery(".card.right").removeClass('active');
  o.addClass('active');
}

//id, container, image, label, id, classname
function addCard(id, container, image, label, classname = '') {
   
    var c = `<div class="card small ${classname}" id='${id}'>
      <div class="section media"><img src="${image}"/>
      </div>
      <div class="section meta">${label}</div>
      </div>`;

    jQuery("#" + container).append(c);

}

function setMode() {
  switch(mode) {
    case 'update':
      jQuery('.create').text('Update');
    break;
    case 'create':
      jQuery('.create').text('Create');
    break;
  }
}

function populateViewer(a) {
    console.log(a);
    
    console.log(a.body[1].service[0].id + "/info.json");
    viewer.open(a.body[1].service[0].id + "/info.json");
    /*
    var parts = a.body[1].id.split('/');
    jQuery('#ID').val(a.id);
    jQuery('#region').val(parts[6]);
    jQuery('#rotation').val(parts[8]);
    jQuery('#textbody').val(a.body[0].value);
    jQuery('#tagbody').val('');
    */
}





jQuery(".create").click(function(e) {

    var ID = jQuery("#ID").val();
    var text = jQuery("#textbody").val();
    var tags = jQuery("#tagbody").val();
    var region = jQuery("#region").val();
    var rotation = jQuery("#rotation").val();
    var image = jQuery("#image").val();
    
    // New annotation
    if(ID !='') {
       console.log(crops[ID].body[1]);
      crops[ID].body[1].id = image;
      crops[ID].body[0].value = text;
      drawCrops();
      resetForm();
      
    }
    // update an annotation
    else {
      var id = makeid();
      var z = new Annotation(id);
      z.setLabel(text);
      z.setCanvas(current.target.source.id);
      z.setManifest(current.target.source.partOf.source);
      z.setImageBody(current.body[1].service[0].id, region, rotation);
      if(region != 'full') { z.setSelector(region); }
      crops[id] = z;
      tilesources[id] = current.body[1].service[0].id;
      
      crops[id] = z;
      drawCrops();
      resetForm();
      //jQuery("#gallery-right-slider").append(z.makeCard('right'));
    }
    e.preventDefault();
    //c.toggleCrop();
    c.clear();

    jQuery("#textbody").val('');
    jQuery("#tagbody").val('');
    jQuery("#region").val('');
    jQuery("#rotation").val('0');    
});


jQuery("#input").submit(function(e) {
    var url = jQuery("#url").val();
    loadManifest(url);
    e.preventDefault();
});


jQuery("#export").click(function(e) {
    console.log(crops);
    e.preventDefault;
});



function setViewer(service, region) {
    // open image in OSD -----------------------------------
    viewer.open(service + "/info.json");

    if (current.region != "") {

        viewer.addHandler("open", openHandler);

        function openHandler() {
            viewer.removeHandler("open", openHandler);
            var imageCoords = region.split(",");
            var tl = viewer.viewport.imageToViewportCoordinates(imageCoords[0], imageCoords[1]);
            var br = viewer.viewport.imageToViewportCoordinates(imageCoords[2], imageCoords[3]);
            var box1 = new OpenSeadragon.Rect(tl.x, tl.y, br.x, br.y);
            viewer.viewport.fitBounds(box1);
        }
    }

}





class Annotation {

    constructor(id) {
        this['@context'] = "http://www.w3.org/ns/anno.jsonld";
        this.type = "Annotation";
        this.id = id;
        this.body = [{
            "type": "TextualBody",
            "value": "",
            "purpose": "commenting"
        }];
        this.target = {
            "source": {
                "id": "",
                "type": "Canvas",
                "partOf": {
                    "source": "",
                    "type": "Manifest"
                }
            }

        };
    }

    setImageBody(serviceurl, region, rotation) {

        var url = `${serviceurl}/${region}/300,/${rotation}/default.jpg`;

        var imagebody = {
            "id": url,
            "type": "Image",
            "format": "image/jpeg",
            "width": 999,
            "height": 999,
            "service": [{
                "id": serviceurl,
                "type": "ImageService3",
                "profile": "level2"
            }]
        }
        this.body.push(imagebody);
    }
    setLabel(str) {
        this.body[0].value = str;
    }

    setCanvas(str) {
        this.target.source.id = str;
    }
    setManifest(str) {
        this.target.source.partOf.source = str;
    }
    setSelector(region) {
        region = region.replace('pixel:', '').replace('xywh=', '');
        region = region.split(',').map(num => parseInt(num, 10)).join(',');
        var selector = {
            "type": "FragmentSelector",
            "conformsTo": "http://www.w3.org/TR/media-frags/",
            "value": "xywh=" + region
        }
        this.target.source['selector'] = selector;
    }

    makeCard(classname) {

        var service = this.body[1].service[0].id;
        var region = this.body[1].service[0].id;
        //console.log(this);
        var image = this.body[1].id;
        //if(this.body[1]) { var image = this.body[1]; }
        //else { var image = service + "/full/,300/0/default.jpg"; }

        return `<div class="card small ${classname}" id='${this.id}'>
      <div class="section media"><img src="${image}"/>
      </div>
      <div class="section meta">${this.body[0].value}</div>
      </div>`;

    }
}





// Function to make cards draggable and reorderable
// this is currently not used
function makeCardDraggable(card) { 
  card.draggable = true;

  card.addEventListener('dragstart', (e) => {
    // Prevent dragging if clicking on image or links
    if (e.target.tagName === 'IMG' || e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
      return;
    }

    card.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', card.innerHTML);
  });

  card.addEventListener('dragend', (e) => {
    card.classList.remove('dragging');
  });

  card.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    const draggingCard = document.querySelector('.dragging');
    if (draggingCard && draggingCard !== card) {
      card.classList.add('drag-over');
    }
  });

  card.addEventListener('dragleave', (e) => {
    card.classList.remove('drag-over');
  });

  card.addEventListener('drop', (e) => {
    e.preventDefault();
    card.classList.remove('drag-over');
    
    const draggingCard = document.querySelector('.dragging');
    if (draggingCard && draggingCard !== card) {
      const gallery = document.getElementById('gallery');
      const allCards = [...gallery.querySelectorAll('.card')];
      const draggedIndex = allCards.indexOf(draggingCard);
      const targetIndex = allCards.indexOf(card);

      if (draggedIndex < targetIndex) {
        card.parentNode.insertBefore(draggingCard, card.nextSibling);
      } else {
        card.parentNode.insertBefore(draggingCard, card);
      }
    }
  });
  
  return card;
}




</script>


</body>
</html>
